<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin Barbearia Davi Dias</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #111;
    color: #fff;
    padding: 1rem;
    max-width: 900px;
    margin: auto;
  }
  h1 { color: #e6b800; text-align: center; }
  #logout-btn {
    margin-top: 1rem;
    padding: 0.7rem 1.2rem;
    border-radius: 6px;
    background: #e6b800;
    color: black;
    font-weight: bold;
    cursor: pointer;
    border: none;
    display: inline-block;
  }
  section {
    background: #222;
    border-radius: 8px;
    margin-top: 1.5rem;
    padding: 1rem;
  }
  button.delete-btn {
    background: #b00000;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 0.3rem 0.6rem;
    cursor: pointer;
    margin-left: 1rem;
  }
  ul {
    list-style: none;
    padding-left: 0;
  }
  li {
    margin-bottom: 0.5rem;
  }
  input[type="file"] {
    margin-top: 0.5rem;
  }
  button.upload-btn {
    margin-top: 0.7rem;
    background: #e6b800;
    color: black;
    border: none;
    border-radius: 6px;
    font-weight: bold;
    cursor: pointer;
    padding: 0.5rem 1rem;
  }
</style>
</head>
<body>

<h1>Área Administrativa - Barbearia Davi Dias</h1>
<button id="logout-btn">Sair</button>

<!-- Feedbacks -->
<section>
  <h2>Feedbacks</h2>
  <ul id="feedback-list"></ul>
</section>

<!-- Galeria -->
<section>
  <h2>Galeria - Fotos e Vídeos</h2>
  <ul id="galeria-list"></ul>

  <h3>Adicionar Arquivo</h3>
  <input type="file" id="file-input" accept="image/*,video/*" />
  <br/>
  <button class="upload-btn" id="upload-btn">Enviar para Galeria</button>
  <div id="upload-msg"></div>
</section>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getDatabase,
    ref,
    onValue,
    remove
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
  import {
    getStorage,
    ref as sRef,
    listAll,
    getDownloadURL,
    deleteObject,
    uploadBytes
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

  // Config Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyDx2IBIdo7_b0P9tMWhkxAvM0ehBa9cYas",
    authDomain: "testgithub-d13a2.firebaseapp.com",
    databaseURL: "https://testgithub-d13a2-default-rtdb.firebaseio.com",
    projectId: "testgithub-d13a2",
    storageBucket: "testgithub-d13a2.appspot.com",
    messagingSenderId: "847448063225",
    appId: "1:847448063225:web:1f51f702060de265f6898e"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth();
  const db = getDatabase(app);
  const storage = getStorage(app);

  const logoutBtn = document.getElementById("logout-btn");
  const feedbackList = document.getElementById("feedback-list");
  const galeriaList = document.getElementById("galeria-list");
  const fileInput = document.getElementById("file-input");
  const uploadBtn = document.getElementById("upload-btn");
  const uploadMsg = document.getElementById("upload-msg");

  // Logout
  logoutBtn.addEventListener("click", () => {
    signOut(auth);
  });

  // Controle de acesso e carregamento dados
  onAuthStateChanged(auth, user => {
    if (!user) {
      window.location.href = "login.html";
      return;
    }
    // Carrega os dados
    carregarFeedbacks();
    carregarGaleria();
  });

  // Função para carregar feedbacks e mostrar na lista
  function carregarFeedbacks() {
    const feedbackRef = ref(db, "feedbacks");
    onValue(feedbackRef, snapshot => {
      feedbackList.innerHTML = "";
      snapshot.forEach(childSnap => {
        const key = childSnap.key;
        const fb = childSnap.val();

        const li = document.createElement("li");
        li.textContent = `${fb.nome} (${'⭐'.repeat(fb.nota)}): ${fb.comentario}`;

        const delBtn = document.createElement("button");
        delBtn.textContent = "Excluir";
        delBtn.className = "delete-btn";
        delBtn.addEventListener("click", () => excluirFeedback(key));

        li.appendChild(delBtn);
        feedbackList.appendChild(li);
      });
    });
  }

  // Excluir feedback
  function excluirFeedback(key) {
    if (confirm("Excluir esse feedback?")) {
      remove(ref(db, "feedbacks/" + key))
        .then(() => alert("Feedback excluído."))
        .catch(err => alert("Erro ao excluir: " + err.message));
    }
  }

  // Carregar galeria (lista os arquivos)
  function carregarGaleria() {
    galeriaList.innerHTML = "Carregando...";
    const galeriaRef = sRef(storage, "galeria/");
    listAll(galeriaRef)
      .then(res => {
        galeriaList.innerHTML = "";
        if(res.items.length === 0){
          galeriaList.textContent = "Nenhum arquivo na galeria.";
          return;
        }
        res.items.forEach(item => {
          getDownloadURL(item).then(url => {
            const li = document.createElement("li");

            if(item.name.match(/\.(jpg|jpeg|png|gif)$/i)){
              const img = document.createElement("img");
              img.src = url;
              img.style.width = "100px";
              img.style.borderRadius = "6px";
              img.style.verticalAlign = "middle";
              li.appendChild(img);
            } else if(item.name.match(/\.(mp4|mov|webm)$/i)){
              const video = document.createElement("video");
              video.src = url;
              video.controls = true;
              video.width = 120;
              li.appendChild(video);
            }

            const span = document.createElement("span");
            span.textContent = " " + item.name;

            const delBtn = document.createElement("button");
            delBtn.textContent = "Excluir";
            delBtn.className = "delete-btn";
            delBtn.addEventListener("click", () => excluirArquivo(item.fullPath));

            li.appendChild(span);
            li.appendChild(delBtn);
            galeriaList.appendChild(li);
          });
        });
      })
      .catch(err => {
        galeriaList.textContent = "Erro ao carregar galeria: " + err.message;
      });
  }

  // Excluir arquivo da galeria
  function excluirArquivo(path) {
    if (confirm("Excluir este arquivo da galeria?")) {
      const fileRef = sRef(storage, path);
      deleteObject(fileRef)
        .then(() => {
          alert("Arquivo excluído.");
          carregarGaleria();
        })
        .catch(err => alert("Erro ao excluir arquivo: " + err.message));
    }
  }

  // Upload arquivo
  uploadBtn.addEventListener("click", () => {
    uploadMsg.textContent = "";
    const file = fileInput.files[0];
    if (!file) {
      uploadMsg.style.color = "#f88";
      uploadMsg.textContent = "Selecione um arquivo para enviar.";
      return;
    }

    const storageRef = sRef(storage, "galeria/" + file.name);

    uploadBytes(storageRef, file)
      .then(() => {
        uploadMsg.style.color = "lightgreen";
        uploadMsg.textContent = "Arquivo enviado com sucesso!";
        fileInput.value = "";
        carregarGaleria();
      })
      .catch(err => {
        uploadMsg.style.color = "#f88";
        uploadMsg.textContent = "Erro no upload: " + err.message;
      });
  });
</script>
</body>
</html>
